<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:local="clr-namespace:MackiesPhoneApp.Services"
             x:Class="MackiesPhoneApp.Pages.User.OrderPage"
             x:Name="OrderPageRoot"
             Title="">

    <ScrollView>
        <StackLayout Padding="10"
                     BackgroundColor="{AppThemeBinding Light={StaticResource AppToolbarBackgroundColorLight}, 
                                                        Dark={StaticResource AppToolbarBackgroundColorDark}}">

            <!-- Filter toggle -->
            <Button Text="Filtre"
                    WidthRequest="200"
                    Margin="5,0,0,20"
                    BackgroundColor="White"
                    TextColor="Black"
                    Clicked="OnToggleShowFilters" />

            <!-- Filters -->
            <VerticalStackLayout IsVisible="{Binding ShowFilters}" Spacing="20">

                <!-- Category filter -->
                <CollectionView x:Name="ProductCategoriesView"
                                ItemsSource="{Binding ProductCategories}">
                    <CollectionView.Header>
                        <Frame Padding="10"
                               WidthRequest="200"
                               Margin="5,20,0,0"
                               BorderColor="LightGray"
                               HasShadow="False">
                            <Label Text="Vælg produktkategori"
                                   TextColor="Black"
                                   FontSize="14"
                                   FontAttributes="Bold"
                                   Margin="5"/>
                        </Frame>
                    </CollectionView.Header>

                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <Frame Padding="10"
                                   WidthRequest="200"
                                   Margin="5"
                                   BorderColor="LightGray"
                                   HasShadow="False">

                                <!-- Background when selected -->
                                <Frame.Triggers>
                                    <DataTrigger TargetType="Frame"
                                                 Binding="{Binding IsSelected}"
                                                 Value="True">
                                        <Setter Property="BackgroundColor" Value="LightBlue" />
                                    </DataTrigger>
                                    <DataTrigger TargetType="Frame"
                                                 Binding="{Binding IsSelected}"
                                                 Value="False">
                                        <Setter Property="BackgroundColor" Value="LightGray" />
                                    </DataTrigger>
                                </Frame.Triggers>

                                <HorizontalStackLayout HeightRequest="20" Spacing="10">
                                    <CheckBox IsChecked="{Binding IsSelected}"
                                              InputTransparent="True"
                                              Scale="0.8"
                                              Color="Black" />
                                    <Label Text="{Binding CategoryName}"
                                           FontSize="14"
                                           TextColor="Black"
                                           VerticalOptions="Center" />
                                </HorizontalStackLayout>

                                <Frame.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="OnCategoryRowTapped" />
                                </Frame.GestureRecognizers>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

                <!-- Product type filter -->
                <CollectionView x:Name="ProductTypesView"
                                ItemsSource="{Binding ProductTypes}">
                    <CollectionView.Header>
                        <Frame Padding="10"
                               WidthRequest="200"
                               Margin="5"
                               BorderColor="LightGray"
                               HasShadow="False">
                            <Label Text="Vælg produkttype"
                                   TextColor="Black"
                                   FontSize="14"
                                   FontAttributes="Bold"
                                   Margin="5"/>
                        </Frame>
                    </CollectionView.Header>

                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <Frame Padding="10"
                                   WidthRequest="200"
                                   Margin="5"
                                   BorderColor="LightGray"
                                   HasShadow="False">

                                <!-- Background when selected -->
                                <Frame.Triggers>
                                    <DataTrigger TargetType="Frame"
                                                 Binding="{Binding IsSelected}"
                                                 Value="True">
                                        <Setter Property="BackgroundColor" Value="LightBlue" />
                                    </DataTrigger>
                                    <DataTrigger TargetType="Frame"
                                                 Binding="{Binding IsSelected}"
                                                 Value="False">
                                        <Setter Property="BackgroundColor" Value="LightGray" />
                                    </DataTrigger>
                                </Frame.Triggers>

                                <HorizontalStackLayout HeightRequest="20" Spacing="10">
                                    <CheckBox IsChecked="{Binding IsSelected}"
                                              InputTransparent="True"
                                              Scale="0.8"
                                              Color="Black" />
                                    <Label Text="{Binding Name}"
                                           FontSize="14"
                                           TextColor="Black"
                                           VerticalOptions="Center" />
                                </HorizontalStackLayout>

                                <Frame.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="OnProductTypeRowTapped" />
                                </Frame.GestureRecognizers>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

            </VerticalStackLayout>

            <!-- Order items -->
            <CollectionView x:Name="OrderItemsCollectionView"
                            SelectionMode="None">

                <CollectionView.ItemTemplate Margin="20">
                    <DataTemplate>
                        <Frame CornerRadius="5"
                               Padding="10"
                               Margin="2"
                               BackgroundColor="{AppThemeBinding Light={StaticResource ViewItemBorderColorLight}, 
                                                                  Dark={StaticResource ViewItemBorderColorDark}}">
                            <Frame CornerRadius="8"
                                   Padding="0"
                                   Margin="0"
                                   BackgroundColor="{AppThemeBinding Light={StaticResource ViewItemBackgroundColorLight},
                                                                      Dark={StaticResource ViewItemBackgroundColorDark}}">
                                <Frame.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="OnOrderItemTapped" />
                                </Frame.GestureRecognizers>

                                <Grid ColumnSpacing="10"
                                      HorizontalOptions="Start">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="*" />
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition />
                                        <RowDefinition />
                                        <RowDefinition />
                                    </Grid.RowDefinitions>

                                    <!-- Product image -->
                                    <Image Grid.Column="0"
                                           Source="{Binding imageurl}"
                                           WidthRequest="190"
                                           HeightRequest="190"
                                           Aspect="AspectFill"
                                           VerticalOptions="Center" />

                                    <!-- Product info -->
                                    <VerticalStackLayout Grid.Column="1"
                                                         VerticalOptions="Center"
                                                         Spacing="2">
                                      

                                        <Border
                                            StrokeShape="RoundRectangle 12"
                                            BackgroundColor="#5470a9"
                                            StrokeThickness="0"
                                            HorizontalOptions="Start"
                                            WidthRequest="100"
                                            HeightRequest="25"
                                            Margin="0,10,0,0"
                                            Padding="6,2,2,2">
                                            <Label
                                                HorizontalOptions="Center"
                                                Text="{Binding Badge}"
                                                FontSize="12"
                                                TextColor="White">  
                                             
                                            </Label>
                                        </Border>
                                        
                                        <Label Text="{Binding productname}" FontSize="16" TextColor="White" />
                                        <Label Text="{Binding SalesWeight}" FontSize="14" TextColor="White" />
                                        <!-- Labels -->
                                        <CollectionView x:Name="ProductLabelsOnProduct"                                                
                                                        ItemsSource="{Binding productlabels}">
                                                <!--<CollectionView.Header>
                                                    <StackLayout Padding="10"
                                                      BackgroundColor="LightGray"
                                                      HorizontalOptions="StartAndExpand">
                                                        <Label Text="Mærkning"
                                                            FontSize="14"
                                                            FontAttributes="Bold"
                                                            HorizontalOptions="Center" />   
                                                </StackLayout>
                                            </CollectionView.Header>-->
                                            <CollectionView.ItemTemplate>
                                                <DataTemplate>
                                                    <HorizontalStackLayout>
                                                        <Image Source="{Binding ImageUrl}"
                                                        WidthRequest="20"
                                                        HeightRequest="20"
                                                        Aspect="AspectFill"
                                                        VerticalOptions="Center" />
                                                        <!--<Label Text="{Binding LabelName}"
                                                        FontSize="14"
                                                        Margin="10,0,0,0"
                                                        TextColor="White"
                                                        HorizontalTextAlignment="Start" />-->  
                                                    </HorizontalStackLayout>
                                                </DataTemplate>
                                            </CollectionView.ItemTemplate>
                                        </CollectionView>   
                                        <!--<Label Text="{Binding productdescription}" FontSize="16" TextColor="White" />-->
                                        <Label Text="{Binding unitprice, StringFormat='{0:C}/stk.'}" FontSize="18" TextColor="black" Margin="0,12,0,0"/>
                                        <Label Text="{Binding PricePerKg, StringFormat='{0:C} kr/kg.'}" FontSize="12" TextColor="black" />
                                     
                                        
                                     

                                        <!-- Quantity controls -->
                                        <HorizontalStackLayout Spacing="8">
                                            <Image Source="minussign.png"
                                                   WidthRequest="20"
                                                   BackgroundColor="Transparent"
                                                   IsVisible="{Binding IsQuantityEditable}">
                                                <Image.GestureRecognizers>
                                                    <TapGestureRecognizer Tapped="OnImageMinusTapped" />
                                                </Image.GestureRecognizers>
                                            </Image>
                                            <Label Text="{Binding quantity, StringFormat='{0} stk.'}"
                                                   FontSize="14"
                                                   VerticalOptions="Center"
                                                   TextColor="White"
                                                   IsVisible="{Binding IsQuantityVisible}" />
                                            <Image Source="plussign.png"
                                                   WidthRequest="20"
                                                   HeightRequest="20"
                                                   BackgroundColor="Transparent"
                                                   IsVisible="{Binding IsQuantityEditable}">
                                                <Image.GestureRecognizers>
                                                    <TapGestureRecognizer Tapped="OnImagePlusTapped" />
                                                </Image.GestureRecognizers>
                                            </Image>
                                            <!--<Image Source="shoppingbasket.png"
                                                   WidthRequest="40"
                                                   HeightRequest="40"
                                                   BackgroundColor="Transparent"
                                                   IsVisible="{Binding IsInBasket}">
                                                <Image.GestureRecognizers>
                                                    <TapGestureRecognizer Tapped="OnImagePlusTapped" />
                                                </Image.GestureRecognizers>
                                            </Image>-->
                                        </HorizontalStackLayout>

                                        <!-- Line total -->
                                        <Label Text="{Binding LineTotal, StringFormat='ialt: {0} kr.'}"
                                               FontSize="15"
                                               HorizontalOptions="End"
                                               VerticalOptions="Center"
                                               TextColor="White"
                                               IsVisible="{Binding IsInBasket}" />

                                        <!-- Actions -->



                                        <ImageButton
                                                Source="shoppingbasket.png"
                                                WidthRequest="40"
                                                HeightRequest="40"
                                                BackgroundColor="Transparent"
                                                HorizontalOptions="Start"
                                                Clicked="OnAddToBasketClicked"> 

                                            <ImageButton.Triggers>
                                                <DataTrigger TargetType="ImageButton"
                                                             Binding="{Binding IsInBasket}"
                                                             Value="True">  
                                                    <Setter Property="IsVisible" Value="False" />
                                                </DataTrigger>
                                                <DataTrigger TargetType="ImageButton"
                                                             Binding="{Binding IsInBasket}"
                                                             Value="False"> 
                                                    <Setter Property="IsVisible" Value="True" />
                                                </DataTrigger>
                                            </ImageButton.Triggers>
                                        </ImageButton>


                                        

                                        <Button Text="Vis detaljer"
                                                WidthRequest="150"
                                                FontSize="12"
                                                Padding="6,2"
                                                CornerRadius="12"
                                                HorizontalOptions="Start"
                                                BackgroundColor="White"
                                                TextColor="Black"
                                                Clicked="OnDetailsTapped" />
                                        
                                        <Label Text="{Binding ShelfLife}" FontSize="14" TextColor="White" />
                                    </VerticalStackLayout>
                                   
                                    <!-- Categories -->
                                    <CollectionView x:Name="CategoriesOnProduct"
                                                    Grid.Row="1"
                                                    Grid.Column="0"
                                                    ItemsSource="{Binding productcategories}">
                                        <CollectionView.Header>
                                            <StackLayout Padding="10" BackgroundColor="LightGray">
                                                <Label Text="Kategori"
                                                       FontSize="14"
                                                       FontAttributes="Bold"
                                                       HorizontalOptions="Center" />
                                            </StackLayout>
                                        </CollectionView.Header>
                                        <CollectionView.ItemTemplate>
                                            <DataTemplate>
                                                <Label Text="{Binding CategoryName}"
                                                       FontSize="14"
                                                       Margin="10,0,0,0"
                                                       TextColor="White" />
                                            </DataTemplate>
                                        </CollectionView.ItemTemplate>
                                    </CollectionView>

                                    <!-- Product types -->
                                    <CollectionView x:Name="ProductTypesOnProduct"
                                                    Grid.Row="1"
                                                    Grid.Column="1"
                                                    ItemsSource="{Binding producttypes}">
                                        <CollectionView.Header>
                                            <StackLayout Padding="10"
                                                         BackgroundColor="LightGray"
                                                         HorizontalOptions="StartAndExpand">
                                                <Label Text="Type"
                                                       FontSize="14"
                                                       FontAttributes="Bold"
                                                       HorizontalOptions="Center" />
                                            </StackLayout>
                                        </CollectionView.Header>
                                        <CollectionView.ItemTemplate>
                                            <DataTemplate>
                                                <Label Text="{Binding Name}"
                                                       FontSize="14"
                                                       Margin="10,0,0,0"
                                                       TextColor="White"
                                                       HorizontalTextAlignment="Start" />
                                            </DataTemplate>
                                        </CollectionView.ItemTemplate>
                                    </CollectionView>
                                </Grid>
                            </Frame>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

        </StackLayout>
    </ScrollView>
</ContentPage>
